const icsFiles = 
{
  "KraftWerket.ics": {
    "url": "https://kraftwerket.kk.dk/en/events",
    "type": "KK"
  },
  "Kulturhuset Islands Brygge.ics": {
    "url": "https://kulturhusetislandsbrygge.kk.dk/koncerter",
    "type": "KK"
  },
  "Mayhem.ics": {
    "url": "https://mayhemkbh.dk",
    "type": "Custom"
  },
  "Spillestedet Stengade.ics": {
    "url": "https://www.facebook.com/spillestedetstengade/events",
    "type": "Facebook"
  },
  "HUSET.ics": {
    "url": "https://huset.kk.dk/en/events",
    "type": "KK"
  },
  "Villa Kultur.ics": {
    "url": "https://www.facebook.com/villakultur/events",
    "type": "Facebook"
  },
  "R\u00e5huset.ics": {
    "url": "https://www.facebook.com/Raahuset/events",
    "type": "Facebook"
  },
  "Mayhem KBH.ics": {
    "url": "https://www.facebook.com/mayhemkbh/events",
    "type": "Facebook"
  },
  "ALICE cph.ics": {
    "url": "https://www.facebook.com/alicecphcom/events",
    "type": "Facebook"
  },
  "Musik Loppen.ics": {
    "url": "https://www.facebook.com/musikloppen/events",
    "type": "Facebook"
  },
  "KoncertKirken.ics": {
    "url": "https://www.facebook.com/koncertkirken/events",
    "type": "Facebook"
  },
  "RUST.ics": {
    "url": "https://www.facebook.com/RUSTkbh/events",
    "type": "Facebook"
  },
  "Pumpehuset.ics": {
    "url": "https://www.facebook.com/Pumpehuset/events/",
    "type": "Facebook"
  },
  "Musikcaf\u00e9en.ics": {
    "url": "https://www.facebook.com/musikcafeenihuset/events",
    "type": "Facebook"
  },
  "HUSET  (Huset i Magstr\u00e6de).ics": {
    "url": "https://www.facebook.com/Huset.Koebenhavn/events",
    "type": "Facebook"
  },
  "Basement CPH.ics": {
    "url": "https://www.facebook.com/BasementKBH/events",
    "type": "Facebook"
  },
  "VEGA.ics": {
    "url": "https://www.facebook.com/VEGAcph/events",
    "type": "Facebook"
  },
  "Operaen Christiania.ics": {
    "url": "https://www.facebook.com/operaenscafe/events",
    "type": "Facebook"
  },
  "Punks Undead.ics": {
    "url": "https://www.facebook.com/PunksUndeadCPH/events",
    "type": "Facebook"
  },
  "Ungdomshuset.ics": {
    "url": "https://www.facebook.com/UngdomshusetD61/events",
    "type": "Facebook"
  },
  "Radar.ics": {
    "url": "https://www.facebook.com/radarlive/events",
    "type": "Facebook"
  },
  "DROP INN.ics": {
    "url": "https://www.facebook.com/dropinnmusic/events",
    "type": "Facebook"
  },
  "Haven CPH.ics": {
    "url": "https://www.facebook.com/havencph/events",
    "type": "Facebook"
  },
  "Hangaren.ics": {
    "url": "https://www.facebook.com/HangarenCopenhagen/events",
    "type": "Facebook"
  },
  "Hotel Cecil.ics": {
    "url": "https://www.facebook.com/hotelcecilcph/events",
    "type": "Facebook"
  },
  "Ukirke.ics": {
    "url": "https://www.facebook.com/uKirke/events",
    "type": "Facebook"
  },
  "BETA2300.ics": {
    "url": "https://www.facebook.com/beta2300/events",
    "type": "Facebook"
  },
  "Amager Bio.ics": {
    "url": "https://www.facebook.com/amagerbio/events",
    "type": "Facebook"
  },
  "Polychrome.ics": {
    "url": "https://www.facebook.com/profile.php?id=100057501157471&sk=events",
    "type": "Facebook"
  },
  "LiteraturHaus.ics": {
    "url": "https://www.facebook.com/literaturhauskbh/events",
    "type": "Facebook"
  },
  "Lygtens Kro.ics": {
    "url": "https://www.facebook.com/lygtenskro/events",
    "type": "Facebook"
  },
  "Klub Werkstatt.ics": {
    "url": "https://www.facebook.com/klubwerkstatt/events",
    "type": "Facebook"
  },
  "Absalon.ics": {
    "url": "https://www.facebook.com/absaloncph/events",
    "type": "Facebook"
  },
  "S\u00f8hesten.ics": {
    "url": "https://www.facebook.com/Sohestenbar/events/",
    "type": "Facebook"
  },
  "Husets Biograf.ics": {
    "url": "https://www.facebook.com/HusetsBiograf/events",
    "type": "Facebook"
  },
  "Folkets Hus.ics": {
    "url": "https://www.facebook.com/folketshus50/events",
    "type": "Facebook"
  },
  "St\u00f8dd\u00e6mperen.ics": {
    "url": "https://www.facebook.com/StoedNV/events",
    "type": "Facebook"
  },
  "Bolsjefabrikken.ics": {
    "url": "https://www.facebook.com/Bolsjefabrikkerne/events",
    "type": "Facebook"
  },
  "Den Anden Side.ics": {
    "url": "https://www.facebook.com/KlubDenAndenSide/events",
    "type": "Facebook"
  },
  "CPH ZINE FEST.ics": {
    "url": "https://www.facebook.com/cphzinefest/events",
    "type": "Facebook"
  },
  "J\u00e6gersborggade.ics": {
    "url": "https://www.facebook.com/Jaegersborggade/events",
    "type": "Facebook"
  },
  "Next House Copenhagen.ics": {
    "url": "https://www.facebook.com/nexthousecopenhagen/events",
    "type": "Facebook"
  },
  "Madboks.ics": {
    "url": "https://www.facebook.com/Madboks/events",
    "type": "Facebook"
  },
  "LGBT+ Medborgerhuset i K\u00f8benhavn.ics": {
    "url": "https://www.facebook.com/LGBTmedborgerhuset/events",
    "type": "Facebook"
  },
  "Bastard Caf\u00e9 - Board Games & Coffee.ics": {
    "url": "https://www.facebook.com/BastardCafe/events",
    "type": "Facebook"
  },
  "Empire Bio.ics": {
    "url": "https://www.facebook.com/empirebio.dk/events",
    "type": "Facebook"
  },
  "MarmeladeCulture.ics": {
    "url": "https://www.facebook.com/JamCultureMusic/events",
    "type": "Facebook"
  },
  "ICC Theatre - Improv Comedy Copenhagen.ics": {
    "url": "https://www.facebook.com/improvcomedycph/events",
    "type": "Facebook"
  },
  "B\u00f8ssehuset.ics": {
    "url": "https://www.facebook.com/boessehuset/events",
    "type": "Facebook"
  },
  "DISTORTION.ics": {
    "url": "https://www.facebook.com/cphdistortion/events",
    "type": "Facebook"
  },
  "MIX COPENHAGEN.ics": {
    "url": "https://www.facebook.com/mixcph/events",
    "type": "Facebook"
  },
  "Copenhagen Jazz Festival.ics": {
    "url": "https://www.facebook.com/cphjazzfestival/events",
    "type": "Facebook"
  },
  "CPH DOX.ics": {
    "url": "https://www.facebook.com/cphdox/events",
    "type": "Facebook"
  },
  "Copenhagen Short Film Festival.ics": {
    "url": "https://www.facebook.com/CopenhagenShortFilmFestival/events",
    "type": "Facebook"
  },
  "VOID - International Animation Film Festival.ics": {
    "url": "https://www.facebook.com/voidfilmfestival/events",
    "type": "Facebook"
  }
}

const EVENT_TAGS = ["MUSIC", "MOVIE", "ACTIVISM", "COMMUNITY", "CULTURE", "LGBTQ+", "YOGA", "SPORTS", "ART", "COMEDY", "SHOPPING", "GAMES", "QUIZ"];

const TAG_EMOJIS = {
    "MUSIC": "üéµ",
    "MOVIE": "üé¨",
    "ACTIVISM": "‚úä",
    "COMMUNITY": "ü§ù",
    "CULTURE": "üèõÔ∏è",
    "LGBTQ+": "üè≥Ô∏è‚Äçüåà",
    "YOGA": "üßò",
    "SPORTS": "‚öΩ",
    "ART": "üé®",
    "COMEDY": "üòÇ",
    "SHOPPING": "üõçÔ∏è",
    "GAMES": "üéÆ",
    "QUIZ": "üß†"
};

let allEvents = [];
let currentWeekStart = moment().startOf('week');

let activeFilters = new Set(Object.keys(icsFiles));
let activeTagFilters = new Set(EVENT_TAGS);

async function fetchICSFile(url) {
  const response = await fetch(url);
  const data = await response.text();
  return data;
}

function parseICSData(icsData, source) {
  const jcalData = ICAL.parse(icsData);
  const comp = new ICAL.Component(jcalData);
  return comp.getAllSubcomponents('vevent').map(vevent => {
    const event = new ICAL.Event(vevent);
    return {
      summary: event.summary,
      description: event.description,
      start: event.startDate.toJSDate(),
      end: event.endDate.toJSDate(),
      url: vevent.getFirstPropertyValue('url'),
      location: event.location,
      imageUrl: vevent.getFirstPropertyValue('x-cover-image-url'),
      source: source,
      venueUrl: icsFiles[source].url,
      venueType: icsFiles[source].type,
      tag: vevent.getFirstPropertyValue('x-event-tags') || "UNCATEGORIZED"
    };
  });
}

async function loadAllEvents() {
  const promises = Object.entries(icsFiles).map(([file, info]) => {
    return fetchICSFile(file).then(icsData => parseICSData(icsData, file));
  });
  const events = await Promise.all(promises);
  allEvents = events.flat();
  displayEvents();
}

function displayEvents() {
  const eventList = document.getElementById('eventList');
  eventList.innerHTML = '';

  let eventStartFilter = (currentWeekStart.isSame(moment().startOf('week'))) ? moment().startOf('day') : currentWeekStart;
  const weekEnd = moment(currentWeekStart).endOf('week');

  const filteredSummaries = new Set();

  const eventsThisWeek = allEvents.filter(event => {
    if (filteredSummaries.has(event.summary)) return false;

    const isValidDate = moment(event.start).isBetween(eventStartFilter, weekEnd, null, '[]');
    const isValidSource = activeFilters.has(event.source);
    const isValidTag = activeTagFilters.has(event.tag);

    if (isValidDate && isValidSource && isValidTag) {
      filteredSummaries.add(event.summary);
    }

    return isValidDate && isValidSource && isValidTag;
  });

  eventsThisWeek.sort((a, b) => a.start - b.start);

  const groupedEvents = eventsThisWeek.reduce((groups, event) => {
    const date = moment(event.start).format('MMMM D, YYYY');
    if (!groups[date]) {
      groups[date] = [];
    }
    groups[date].push(event);
    return groups;
  }, {});

  for (const [date, events] of Object.entries(groupedEvents)) {
    const dateDivider = document.createElement('div');
    dateDivider.className = 'event-day-divider';
    dateDivider.setAttribute('data-date', date);
    eventList.appendChild(dateDivider);

    const eventContainer = document.createElement('div');
    eventContainer.className = 'event-day-container';
    dateDivider.appendChild(eventContainer);

    events.forEach(event => {
      const eventBox = document.createElement('div');
      eventBox.className = 'event-box';
      eventBox.innerHTML = `  
      <img src="${event.imageUrl || '/api/placeholder/300/200'}" loading="lazy" alt="${event.summary}" class="event-image">
      <div class="event-tag" data-tag="${event.tag}">${event.tag}</div>
      <div class="event-details">
          <div class="event-title">${event.summary.replace(/^\[.*?\]/, '')}</div>
          <div class="event-date">${moment(event.start).format('MMMM D, YYYY - h:mm A')}</div>
          <div class="event-location">üìç ${event.summary.match(/\[(.*?)\]/)[1]}</div>
          <br>
          <div class="event-description">${event.description}</div>
      </div>
  `;
      eventContainer.appendChild(eventBox);
    
      eventBox.addEventListener('click', (e) => {
        if (!e.target.closest('.event-link')) {
          showEventDetails(event);
        }
      });
    });
  }

  updateWeekNavigation();
}

function addToCalendar(event) {
  const startTime = moment(event.start).format('YYYYMMDDTHHmmss');
  const endTime = moment(event.end).format('YYYYMMDDTHHmmss');
  const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.summary)}&dates=${startTime}/${endTime}&details=${encodeURIComponent(event.description)}&location=${encodeURIComponent(event.location || '')}&sprop=&sprop=name:&sprop=X-EVENT-TAGS:${event.tag}`;

  const appleCalendarUrl = `data:text/calendar;charset=utf8,BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
URL:${event.url}
DTSTART:${startTime}
DTEND:${endTime}
SUMMARY:${event.summary}
DESCRIPTION:${event.description}
LOCATION:${event.location || ''}
X-EVENT-TAGS:${event.tag}
END:VEVENT
END:VCALENDAR`;

  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.left = '0';
  modal.style.top = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
  modal.style.display = 'flex';
  modal.style.justifyContent = 'center';
  modal.style.alignItems = 'center';

  const content = document.createElement('div');
  content.style.backgroundColor = 'white';
  content.style.padding = '20px';
  content.style.borderRadius = '10px';
  content.innerHTML = `
        <h3>Add to Calendar</h3>
        <p><a href="${googleCalendarUrl}" target="_blank">Add to Google Calendar</a></p>
        <p><a href="${appleCalendarUrl}" download="event.ics">Add to Apple Calendar</a></p>
        <button id="closeModal">Close</button>
    `;

  modal.appendChild(content);
  document.body.appendChild(modal);

  document.getElementById('closeModal').onclick = () => {
    document.body.removeChild(modal);
    event.stopPropagation();
  };
}

function updateWeekNavigation() {
  const prevWeekBtn = document.getElementById('prevWeek');
  const nextWeekBtn = document.getElementById('nextWeek');
  const weekDisplay = document.getElementById('weekDisplay');

  prevWeekBtn.disabled = currentWeekStart.isSame(moment().startOf('week'));

  const nextWeekStart = moment(currentWeekStart).add(1, 'week').startOf('week');
  const nextWeekEnd = moment(nextWeekStart).endOf('week');
  const hasNextWeekEvents = allEvents.some(event =>
    moment(event.start).isBetween(nextWeekStart, nextWeekEnd, null, '[]') &&
    activeFilters.has(event.source) &&
    activeTagFilters.has(event.tag)
  );

  nextWeekBtn.disabled = !hasNextWeekEvents;

  weekDisplay.textContent = `${currentWeekStart.format('MMMM D')} - ${moment(currentWeekStart).endOf('week').format('MMMM D, YYYY')}`;
}

function createFilterToggles() {
  const tagFilters = document.getElementById('tagFilters');

  if (!tagFilters) {
      console.error('Tag filters container not found!');
      return;
  }

  tagFilters.innerHTML = '';

  // Create filter container
  const filterContainer = document.createElement('div');
  filterContainer.className = 'filter-container';
  tagFilters.appendChild(filterContainer);

  // Add filter toggle button
  const filterToggle = document.createElement('button');
  filterToggle.className = 'filter-toggle';
  filterToggle.innerHTML = '<span>WANT FILTERS, KIDDO?</span>';
  filterToggle.addEventListener('click', toggleFilters);
  filterContainer.appendChild(filterToggle);

  // Create tag filters container
  const tagFiltersContainer = document.createElement('div');
  tagFiltersContainer.className = 'tag-filters';
  tagFiltersContainer.style.display = 'none';
  filterContainer.appendChild(tagFiltersContainer);
  
  //const savedTags = getCookie('activeTags');
  //if (savedTags) {
    //  activeTagFilters = new Set(JSON.parse(savedTags));
  //}
  //else {
      activeTagFilters = new Set(EVENT_TAGS);
  //}

  EVENT_TAGS.forEach(tag => {
    const button = document.createElement('button');
    button.className = 'tag-button';
    button.dataset.tag = tag;
    button.classList.toggle('active', activeTagFilters.has(tag));
    button.style.opacity = '0';
    button.style.transform = 'scale(0)';

    const emoji = document.createElement('span');
    emoji.className = 'emoji';
    emoji.textContent = TAG_EMOJIS[tag] || '';

    const text = document.createElement('span');
    text.textContent = tag;

    button.appendChild(emoji);
    button.appendChild(text);

    button.addEventListener('click', () => {
        button.classList.toggle('active');
        if (activeTagFilters.has(tag)) {
            activeTagFilters.delete(tag);
        } else {
            activeTagFilters.add(tag);
        }
        button.classList.add('shake');
        setTimeout(() => button.classList.remove('shake'), 1);
        displayEvents();
        saveTags();
    });

    tagFiltersContainer.appendChild(button);
});
}

function toggleFilters() {
const filterContainer = document.querySelector('.filter-container');
const filterToggle = filterContainer.querySelector('.filter-toggle');
const tagFiltersContainer = filterContainer.querySelector('.tag-filters');

// Immediately remove the toggle button
filterToggle.remove();

// Show the tag filters container
tagFiltersContainer.style.display = 'flex';

// Get the center position of the container
const containerRect = tagFiltersContainer.getBoundingClientRect();
const centerX = containerRect.width / 2;
const centerY = containerRect.height / 2;

// Animate the appearance of each filter button
const buttons = tagFiltersContainer.querySelectorAll('.tag-button');
buttons.forEach((button, index) => {
    // Set initial position to the center of the container
    button.style.position = 'absolute';
    button.style.left = `${centerX}px`;
    button.style.top = `${centerY}px`;
    
    setTimeout(() => {
        button.style.opacity = '1';
        button.style.transform = 'scale(1)';
        button.style.position = 'relative';
        button.style.left = 'auto';
        button.style.top = 'auto';
        button.classList.add('animate');
    }, index * 50);
});
}

function saveTags() {
  setCookie('activeTags', JSON.stringify(Array.from(activeTagFilters)), 30);
}

function setCookie(name, value, days) {
  let expires = "";
  if (days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}

function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for(let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) == ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}
document.getElementById('prevWeek').addEventListener('click', () => {
  currentWeekStart.subtract(1, 'week');
  displayEvents();
});

document.getElementById('nextWeek').addEventListener('click', () => {
  currentWeekStart.add(1, 'week');
  displayEvents();
});

function showEventDetails(event) {
  const modal = document.getElementById('eventModal');
  const modalImage = document.getElementById('modalImage');
  const modalTitle = document.getElementById('modalTitle');
  const modalDate = document.getElementById('modalDate');
  const modalLocation = document.getElementById('modalLocation');
  const modalDescription = document.getElementById('modalDescription');
  const modalLink = document.getElementById('modalLink');
  const addToCalendarBtn = document.getElementById('addToCalendar');
  const modalTag = document.getElementById('modalTag');

  modalImage.src = event.imageUrl || '/api/placeholder/600/300';
  modalImage.alt = event.summary;
  modalTitle.textContent = event.summary;
  modalDate.textContent = `${moment(event.start).format('MMMM D, YYYY - h:mm A')} to ${moment(event.end).format('h:mm A')}`;
  modalTag.textContent = event.tag;

  if (event.location) {
    modalLocation.innerHTML = '<a href="http://maps.google.com/?q=' + event.location + '" target="_blank">' +  "üìç" + event.location + "</a>";
  } else {
    modalLocation.textContent = 'Location not specified';
  }
  
  let description = event.description.replace(/(https?:\/\/[^\s]+)/g, (match) => {
    return `<a href="${match}" target="_blank">${match}</a>`;
  });
 
  modalDescription.innerHTML = description;
  modalLink.href = event.url;
  addToCalendarBtn.onclick = () => addToCalendar(event);

  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  const modal = document.getElementById('eventModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  document.body.style.position = '';
  document.body.style.width = '';
}

document.addEventListener('DOMContentLoaded', function() {
  createFilterToggles();
  loadAllEvents();

  // Add event listeners for closing the modal
  const modal = document.getElementById('eventModal');
  const closeBtn = modal.querySelector('.close');

  closeBtn.addEventListener('click', closeModal);

  // Updated event listener for click/touch outside modal
  modal.addEventListener('click', function(event) {
    if (event.target === modal) {
      event.preventDefault(); // Prevent default behavior
      event.stopPropagation(); // Stop event from bubbling up
      closeModal();
    }
  });

  // Specific touch event handler for iOS devices
  modal.addEventListener('touchend', function(event) {
    if (event.target === modal) {
      event.preventDefault(); // Prevent default behavior
      event.stopPropagation(); // Stop event from bubbling up
      closeModal();
    }
  }, { passive: false }); // Setting passive to false allows preventDefault

  // Prevent scrolling on the modal content
  modalContent.addEventListener('touchmove', function(event) {
    event.stopPropagation();
  }, { passive: false });
});

document.addEventListener('DOMContentLoaded', function() {
  createFilterToggles();
  loadAllEvents();
});